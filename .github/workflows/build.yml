name: Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: manjarolinux/base:latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed \
            base-devel \
            cmake \
            ninja \
            git \
            extra-cmake-modules \
            meson \
            vala \
            gobject-introspection \
            qt6-base \
            qt6-declarative \
            kirigami \
            ki18n \
            kcoreaddons \
            kauth \
            kcmutils \
            fmt \
            libsigc++-3.0 \
            libsoup3 \
            qcoro
      
      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DMCP_BUILD_LIB=ON \
            -DMCP_BUILD_CLI=OFF \
            -DMCP_BUILD_QT=ON \
            -DMCP_BUILD_QT_CLASSIC=OFF \
            -DMCP_BUILD_KCM=ON
      
      - name: Build
        run: cmake --build build
      
      - name: Install (staging)
        run: |
          DESTDIR="${PWD}/staging" cmake --install build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mcp-build-artifacts
          path: staging/
          retention-days: 7
